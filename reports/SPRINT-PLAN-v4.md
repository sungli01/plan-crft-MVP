# Plan-Craft v4.0 스프린트 계획서

> 작성일: 2026-02-08 | 작성: 바질 (AI PM)

---

## 📊 전체 로드맵 (12주, 6 스프린트)

```
Week 1-2   [Sprint 1] 백엔드 인프라 강화
Week 3-4   [Sprint 2] Free/Pro 모드 & 결제 시스템
Week 5-6   [Sprint 3] 심층 연구 엔진 (Pro 기능)
Week 7-8   [Sprint 4] 목업 사이트 빌더
Week 9-10  [Sprint 5] 문서 고도화 & 협업
Week 11-12 [Sprint 6] 최적화 & 정식 런칭
```

---

## 현재 아키텍처 vs 목표 아키텍처

### 현재 (v3.0 MVP)
```
┌─────────────┐     ┌──────────────────┐     ┌────────────┐
│  Vercel      │────▶│  Railway (Hono)   │────▶│ PostgreSQL │
│  Next.js 14  │     │  JavaScript       │     │ (Railway)  │
│  (Frontend)  │◀────│  JWT Auth         │     └────────────┘
└─────────────┘     │  In-memory Rate   │
   Polling 3s       │  No Cache         │     ┌────────────┐
                    │  No WebSocket     │────▶│ Anthropic  │
                    │  No Tests         │     │ Claude API │
                    └──────────────────┘     └────────────┘
```

### 목표 (v4.0)
```
┌─────────────┐     ┌──────────────────────┐     ┌────────────┐
│  Vercel      │◀──▶│  Railway (Hono)       │────▶│ PostgreSQL │
│  Next.js 14  │ WS │  TypeScript           │     └────────────┘
│  (Frontend)  │    │  OAuth + Refresh JWT  │     ┌────────────┐
└─────────────┘    │  Redis Cache/Session  │────▶│   Redis    │
                   │  WebSocket 실시간      │     └────────────┘
                   │  Stripe 결제           │     ┌────────────┐
                   │  Sentry 모니터링       │────▶│ Anthropic  │
                   │  70%+ 테스트 커버리지   │     │ Claude API │
                   └──────────┬───────────┘     └────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
      ┌──────────────┐ ┌───────────┐ ┌──────────────┐
      │ 심층 연구 엔진 │ │ 목업 빌더  │ │ 문서 협업     │
      │ Semantic Sch. │ │ Sandbox   │ │ Real-time    │
      │ arXiv, 공공API│ │ AI Codegen│ │ Collaboration│
      └──────────────┘ └───────────┘ └──────────────┘
```

---

## Sprint 1: 백엔드 인프라 강화 (Week 1-2)

### 🎯 목표
기존 JavaScript 백엔드를 TypeScript로 전환하고, 프로덕션 수준 인프라 구축

### ✅ 작업 항목

#### 1-1. TypeScript 전환
- [ ] `tsconfig.json` 설정 (strict mode)
- [ ] 모든 `.js` → `.ts` 변환 (약 15개 파일)
- [ ] Drizzle ORM 타입 안전성 강화
- [ ] Zod 스키마 → TypeScript 타입 자동 추론
- **예상 소요**: 3일
- **기술**: TypeScript 5.x, tsx runner

#### 1-2. Redis 캐싱 레이어
- [ ] Railway Redis 인스턴스 추가
- [ ] 세션 스토어 (express-session → Redis)
- [ ] Rate limiter Redis 기반 전환 (분산 환경 지원)
- [ ] 문서 생성 결과 캐싱 (TTL 24h)
- [ ] API 응답 캐싱 (프로젝트 목록 등)
- **예상 소요**: 2일
- **기술**: ioredis, @hono/rate-limiter
- **비용**: Railway Redis $5/월

#### 1-3. WebSocket 실시간 통신
- [ ] Hono WebSocket 어댑터 도입
- [ ] 문서 생성 진행 상황 실시간 push (polling 3s 대체)
- [ ] 에이전트 상태 실시간 표시
- [ ] 프론트엔드 WebSocket 클라이언트
- [ ] 재연결 로직 + fallback to polling
- **예상 소요**: 3일
- **기술**: hono/ws, ws 라이브러리

#### 1-4. 인증 강화
- [ ] Refresh Token 구현 (access 15분 + refresh 7일)
- [ ] Google OAuth 2.0 로그인
- [ ] GitHub OAuth 로그인
- [ ] 비밀번호 재설정 (이메일 발송)
- [ ] 계정 잠금 (5회 실패 시 15분)
- **예상 소요**: 3일
- **기술**: arctic (OAuth 라이브러리), nodemailer

#### 1-5. 모니터링 & 테스트
- [ ] Sentry 연동 (에러 트래킹 + 성능 모니터링)
- [ ] Vitest 테스트 프레임워크 설정
- [ ] API 엔드포인트 통합 테스트 작성
- [ ] 에이전트 유닛 테스트
- [ ] 목표 커버리지 70%+
- **예상 소요**: 3일
- **기술**: Vitest, Sentry, supertest

#### 1-6. CI/CD 파이프라인
- [ ] GitHub Actions 워크플로우
- [ ] PR 시 자동 테스트 실행
- [ ] main 브랜치 push 시 자동 배포
- [ ] 린트 + 포맷 체크 (ESLint + Prettier)
- **예상 소요**: 1일
- **기술**: GitHub Actions, ESLint, Prettier

### 📊 성공 지표
- TypeScript strict 모드 컴파일 성공
- Redis 캐시 히트율 60%+
- WebSocket 연결 안정성 99%+
- 테스트 커버리지 70%+
- CI/CD 파이프라인 그린

### ⚠️ 리스크
| 리스크 | 확률 | 영향 | 대응 |
|--------|------|------|------|
| TS 전환 시 런타임 에러 | 중 | 높 | 점진적 전환, strict 단계적 적용 |
| Railway Redis 연결 불안정 | 낮 | 중 | fallback to in-memory |
| WebSocket Railway 제한 | 중 | 중 | SSE(Server-Sent Events)로 대체 |

---

## Sprint 2: Free/Pro 모드 & 결제 시스템 (Week 3-4)

### 🎯 목표
Free/Pro 티어 구분 + Stripe 결제 연동 + 사용량 대시보드

### ✅ 작업 항목

#### 2-1. 티어 시스템 설계
- [ ] DB 스키마: users 테이블에 `tier`, `subscription_id`, `tier_expires_at` 추가
- [ ] Free 제한: 월 3회 생성, 기본 템플릿만, 워터마크
- [ ] Pro 혜택: 무제한 생성, 심층 연구, 우선 처리, 워터마크 제거
- [ ] 미들웨어: 티어별 접근 제어
- **예상 소요**: 2일

#### 2-2. Stripe 결제 연동
- [ ] Stripe 계정 설정 + API 키
- [ ] 구독 상품 생성 (월 ₩29,900 / 연 ₩299,000)
- [ ] Checkout Session API
- [ ] Webhook 처리 (결제 성공/실패/취소)
- [ ] 구독 갱신/해지 로직
- [ ] 영수증 발행
- **예상 소요**: 4일
- **기술**: stripe-node
- **비용**: Stripe 수수료 3.4% + ₩400/건
- **⚠️ 형님 사전 승인 필수**

#### 2-3. 사용량 대시보드
- [ ] 월별 생성 횟수 트래킹
- [ ] API 호출 비용 추정 표시
- [ ] 토큰 사용량 시각화
- [ ] 다음 결제일 / 구독 상태
- **예상 소요**: 2일

#### 2-4. 프론트엔드 Pro 모드 UI
- [ ] 가격 페이지 디자인
- [ ] Pro 배지 & 기능 잠금 UI
- [ ] 업그레이드 유도 모달
- [ ] 결제 완료 플로우
- **예상 소요**: 2일

### 📊 성공 지표
- Stripe 테스트 결제 성공
- Free/Pro 접근 제어 동작
- 구독 라이프사이클 완전 처리 (생성→갱신→해지)

### ⚠️ 리스크
| 리스크 | 확률 | 영향 | 대응 |
|--------|------|------|------|
| Stripe 한국 사업자 등록 필요 | 높 | 높 | 사전 확인, 대안: 토스페이먼츠 |
| 결제 관련 법적 이슈 | 중 | 높 | 이용약관, 환불정책 수립 |

---

## Sprint 3: 심층 연구 엔진 (Week 5-6)

### 🎯 목표
Pro 모드 핵심 기능 — 학술/전문 자료 기반 심층 연구 자동화

### ✅ 작업 항목

#### 3-1. 학술 논문 검색 API
- [ ] Semantic Scholar API 연동 (무료, 100req/5min)
- [ ] arXiv API 연동 (무료, 무제한)
- [ ] CrossRef API (DOI 기반 메타데이터)
- [ ] 검색 결과 정규화 (통일된 논문 포맷)
- **예상 소요**: 3일
- **비용**: 무료 (rate limit 내)

#### 3-2. 공공/전문 데이터 연동
- [ ] 공공데이터포털 (data.go.kr) API
- [ ] KOSIS 국가통계포털
- [ ] 특허정보 (KIPRIS) API
- [ ] 산업 보고서 소스 (KDI, 한국은행 등)
- **예상 소요**: 3일

#### 3-3. 웹 크롤링 엔진
- [ ] Playwright 기반 웹 크롤러
- [ ] 경쟁사/시장 데이터 자동 수집
- [ ] 크롤링 결과 구조화
- [ ] robots.txt 준수
- **예상 소요**: 2일
- **기술**: Playwright

#### 3-4. RAG 파이프라인
- [ ] 수집 데이터 → 벡터 임베딩 (Anthropic/OpenAI)
- [ ] 벡터 스토어 (Pinecone 또는 pgvector)
- [ ] 검색 → 컨텍스트 증강 → 생성
- [ ] 출처/참고문헌 자동 인용 (APA 형식)
- **예상 소요**: 4일
- **기술**: pgvector (PostgreSQL 확장), Claude embeddings
- **비용**: pgvector 무료 (PostgreSQL 내장), 임베딩 API ~$0.01/1K tokens

#### 3-5. 연구 에이전트 통합
- [ ] 새로운 `ResearchAgent` 클래스
- [ ] Orchestrator에 연구 단계 추가 (Architect 전 또는 병렬)
- [ ] 연구 결과 → Writer에 컨텍스트 전달
- [ ] 연구 진행 상황 실시간 표시
- **예상 소요**: 2일

### 📊 성공 지표
- 논문 검색 정확도 80%+ (관련 논문 top-5 기준)
- 참고문헌 자동 생성 정확도 90%+
- 연구 기반 문서 품질 92+/100

### ⚠️ 리스크
| 리스크 | 확률 | 영향 | 대응 |
|--------|------|------|------|
| API rate limit 초과 | 중 | 중 | 캐싱 + 큐 시스템 |
| 크롤링 차단 | 중 | 낮 | 대체 소스, API 우선 |
| 벡터 DB 비용 증가 | 낮 | 중 | pgvector 사용 (무료) |

---

## Sprint 4: 목업 사이트 빌더 (Week 7-8)

### 🎯 목표
웹 솔루션 기획 시 실시간 목업 사이트 자동 생성 및 프리뷰

### ✅ 작업 항목

#### 4-1. AI 코드 생성 엔진
- [ ] Claude를 활용한 HTML/CSS/JS 코드 생성
- [ ] 프롬프트 엔지니어링: 사업 계획 → 웹 목업 코드
- [ ] Tailwind CSS 기반 컴포넌트 생성
- [ ] 반응형 디자인 자동 적용
- **예상 소요**: 4일

#### 4-2. 샌드박스 환경
- [ ] iframe 기반 안전한 코드 실행
- [ ] 별도 서브도메인 배포 (`mockup-{id}.plancraft.app`)
- [ ] 코드 에디터 + 실시간 프리뷰 (split view)
- [ ] 48시간 자동 만료 (비용 관리)
- **예상 소요**: 4일
- **기술**: Cloudflare Workers 또는 Vercel Edge Functions

#### 4-3. 컴포넌트 라이브러리
- [ ] Hero 섹션 5종
- [ ] Feature 섹션 5종
- [ ] Pricing 테이블 3종
- [ ] Footer/Header 3종
- [ ] 폼/CTA 컴포넌트 3종
- **예상 소요**: 3일

#### 4-4. 프론트엔드 UI
- [ ] 목업 빌더 페이지 (`/project/[id]/mockup`)
- [ ] 실시간 프리뷰 패널
- [ ] 데스크톱/태블릿/모바일 뷰 전환
- [ ] 코드 다운로드 기능
- [ ] 목업 → 실제 배포 (Vercel/Netlify)
- **예상 소요**: 3일

### 📊 성공 지표
- 목업 생성 성공률 90%+
- 반응형 정상 동작률 85%+
- 사용자 만족도 (코드 품질)

### ⚠️ 리스크
| 리스크 | 확률 | 영향 | 대응 |
|--------|------|------|------|
| AI 생성 코드 품질 불안정 | 높 | 중 | 템플릿 기반 + AI 커스텀 |
| 샌드박스 보안 이슈 | 중 | 높 | CSP 설정, iframe sandbox 속성 |
| 호스팅 비용 | 중 | 중 | 자동 만료 + 사용량 제한 |

---

## Sprint 5: 문서 고도화 & 협업 (Week 9-10)

### 🎯 목표
문서 공유, 실시간 협업, 버전 관리

### ✅ 작업 항목

#### 5-1. 문서 공유 시스템
- [ ] 공개 링크 생성 (UUID 기반)
- [ ] 접근 권한 (보기/편집/댓글)
- [ ] 비밀번호 보호
- [ ] 만료일 설정
- **예상 소요**: 3일

#### 5-2. 실시간 협업
- [ ] 다중 사용자 동시 편집
- [ ] 커서 위치 실시간 공유
- [ ] 변경 이력 충돌 해결 (OT 또는 CRDT)
- **예상 소요**: 5일
- **기술**: Y.js (CRDT), WebSocket

#### 5-3. 버전 관리
- [ ] 자동 버전 스냅샷 (매 저장)
- [ ] 버전 비교 (diff)
- [ ] 버전 복원
- **예상 소요**: 2일

#### 5-4. 댓글/피드백
- [ ] 인라인 댓글 (텍스트 선택 → 댓글)
- [ ] 전체 댓글 스레드
- [ ] @멘션
- [ ] 이메일 알림
- **예상 소요**: 3일

#### 5-5. 다국어 지원
- [ ] i18n 프레임워크 도입 (next-intl)
- [ ] 영어 번역
- [ ] 일본어 번역
- **예상 소요**: 2일

### 📊 성공 지표
- 동시 편집 안정성 (3명 이상)
- 공유 링크 로드 타임 <2초
- 버전 복원 정확도 100%

---

## Sprint 6: 최적화 & 정식 런칭 (Week 11-12)

### 🎯 목표
성능 최적화, SEO, 보안 강화, 프로덕션 런칭

### ✅ 작업 항목

#### 6-1. 성능 최적화
- [ ] 문서 생성 속도 50% 개선 (병렬 처리 최적화)
- [ ] 프론트엔드 번들 사이즈 최적화
- [ ] 이미지 최적화 (next/image, WebP)
- [ ] CDN 캐싱 설정
- **예상 소요**: 3일

#### 6-2. SEO & 마케팅
- [ ] 메타 태그 최적화
- [ ] 구조화된 데이터 (JSON-LD)
- [ ] 사이트맵 자동 생성
- [ ] 블로그/콘텐츠 페이지
- [ ] Google Analytics / Mixpanel
- **예상 소요**: 2일

#### 6-3. 보안 강화
- [ ] OWASP Top 10 점검
- [ ] SQL 인젝션 방지 (이미 Drizzle ORM)
- [ ] XSS 방지 (CSP 헤더)
- [ ] 보안 헤더 (HSTS, X-Frame-Options 등)
- [ ] 정기 의존성 업데이트 (Dependabot)
- **예상 소요**: 2일

#### 6-4. 온보딩 & UX
- [ ] 가입 후 온보딩 투어
- [ ] 첫 프로젝트 가이드
- [ ] 접근성 (WCAG 2.1 AA)
- [ ] 키보드 내비게이션
- **예상 소요**: 2일

#### 6-5. 부하 테스트 & 스케일링
- [ ] k6 또는 Artillery 부하 테스트
- [ ] 동시 사용자 100명 목표
- [ ] 자동 스케일링 설정
- [ ] 장애 대응 매뉴얼
- **예상 소요**: 2일

#### 6-6. 런칭
- [ ] 프로덕션 환경 최종 점검
- [ ] 도메인 연결 (plancraft.ai)
- [ ] SSL 인증서
- [ ] 이용약관 / 개인정보처리방침
- [ ] 런칭 공지 / Product Hunt 등록
- **예상 소요**: 1일

### 📊 성공 지표
- Lighthouse 점수 90+
- 동시 100명 안정 처리
- 첫 달 가입 100명 목표

---

## 🧠 토큰 최적화 전략 (품질 유지 + 비용 절감)

> 핵심 원칙: **문서 품질 87+/100 유지하면서 토큰 사용량 최대 60% 절감**

### 현재 토큰 사용 분석

```
문서 1건 생성 시 (25 섹션 기준):
┌─────────────────┬──────────┬─────────┬────────────┐
│ 에이전트         │ Input    │ Output  │ 비용 (예상)  │
├─────────────────┼──────────┼─────────┼────────────┤
│ Architect       │ ~3K      │ ~4K     │ $0.06      │
│ Writer (×5)     │ ~15K     │ ~25K    │ $0.32      │
│ Image Curator   │ ~5K      │ ~3K     │ $0.06      │
│ Reviewer        │ ~20K     │ ~5K     │ $0.08      │
├─────────────────┼──────────┼─────────┼────────────┤
│ 합계            │ ~43K     │ ~37K    │ ~$0.52/건  │
└─────────────────┴──────────┴─────────┴────────────┘
```

### 전략 1: 모델 라우팅 (Smart Model Selection)

에이전트별 최적 모델 매핑으로 비용 대비 효과 극대화:

```
┌──────────────────────────────────────────────────────────────┐
│                    Model Routing Matrix                       │
├─────────────────┬──────────────────┬────────────────────────┤
│ 작업              │ 현재 모델          │ 최적화 모델              │
├─────────────────┼──────────────────┼────────────────────────┤
│ Architect       │ Opus 4.6 ($15/M) │ Sonnet 4.5 ($3/M)     │
│ (구조설계)       │                  │ → 구조화 작업에 충분     │
├─────────────────┼──────────────────┼────────────────────────┤
│ Writer (핵심)    │ Opus 4.6         │ Opus 4.6 (유지)        │
│ (핵심 콘텐츠)    │                  │ → 품질 핵심, 타협 불가   │
├─────────────────┼──────────────────┼────────────────────────┤
│ Writer (보조)    │ Opus 4.6         │ Sonnet 4.5             │
│ (부록,참고자료)   │                  │ → 단순 섹션은 Sonnet    │
├─────────────────┼──────────────────┼────────────────────────┤
│ Image Curator   │ Sonnet 4.5       │ Haiku 3.5 ($0.25/M)   │
│ (이미지 매칭)    │                  │ → 키워드 추출은 경량 충분 │
├─────────────────┼──────────────────┼────────────────────────┤
│ Reviewer        │ Sonnet 4.5       │ Sonnet 4.5 (유지)      │
│ (품질 검수)      │                  │ → 평가 정확도 유지 필요   │
└─────────────────┴──────────────────┴────────────────────────┘

예상 절감: 토큰 비용 ~40% 감소 ($0.52 → $0.31/건)
```

**구현 방법:**
- [ ] 섹션 중요도 분류기 (핵심/보조/부록) — Architect 출력에 포함
- [ ] `ModelRouter` 클래스: 섹션 타입 → 모델 자동 매핑
- [ ] Free 모드: Sonnet 전용 / Pro 모드: Opus + Sonnet 혼합
- [ ] A/B 테스트: 모델 혼합 vs 단일 모델 품질 비교

### 전략 2: 프롬프트 압축 (Prompt Compression)

현재 프롬프트에 중복·과잉 정보가 포함됨:

```
[Before] 프롬프트 토큰: ~3,000 tokens/섹션
─────────────────────────────────────────
당신은 전문 비즈니스 문서 작성자입니다.
다음 섹션을 작성해주세요:
- 섹션 제목: {title}
- 문서 전체 목차: {전체 25개 목차 반복}
- 문서 컨텍스트: {전체 아이디어 반복}
- 이전 섹션 내용: {이전 3개 섹션 전문}
- 작성 가이드라인: {500자 가이드}

[After] 프롬프트 토큰: ~800 tokens/섹션
─────────────────────────────────────────
[시스템] 비즈니스 문서 작성 전문가
[컨텍스트] {압축된 아이디어 50자}
[목차요약] 현재: 7/25 | 이전: {title_6} | 다음: {title_8}
[작성] {title} — 800자, 개조식, 데이터 포함
```

**구현 방법:**
- [ ] 프롬프트 템플릿 v2: 시스템 프롬프트 분리 (캐싱 가능)
- [ ] 컨텍스트 압축기: 전체 아이디어 → 핵심 키워드 50자
- [ ] 목차 참조 최소화: 전체 목차 대신 인접 섹션만 전달
- [ ] 이전 섹션 요약: 전문 대신 1줄 요약 전달
- **예상 절감: Input 토큰 ~60% 감소**

### 전략 3: 캐싱 & 재사용 (Smart Caching)

```
┌─────────────────────────────────────────────────┐
│              3-Layer Cache Architecture           │
├─────────────────────────────────────────────────┤
│                                                   │
│  L1: Prompt Cache (Anthropic Native)              │
│  ├─ 시스템 프롬프트 캐싱 (90% 히트율)              │
│  ├─ 동일 prefix 자동 캐싱                          │
│  └─ 비용: 캐시 히트 시 Input 90% 할인              │
│                                                   │
│  L2: Redis Result Cache                           │
│  ├─ 동일 산업/키워드 섹션 캐싱 (TTL 7일)           │
│  ├─ 유사 프로젝트 결과 부분 재사용                  │
│  └─ 키: hash(섹션타입 + 산업 + 키워드)             │
│                                                   │
│  L3: Template Pre-generation                      │
│  ├─ 인기 템플릿 10종 사전 생성 (오프피크)           │
│  ├─ 키워드만 교체하여 즉시 제공                     │
│  └─ Free 모드: 사전 생성 결과 우선 제공             │
│                                                   │
└─────────────────────────────────────────────────┘
```

**구현 방법:**
- [ ] Anthropic Prompt Caching 활용 (시스템 프롬프트 고정)
- [ ] Redis 기반 섹션 결과 캐시 (산업+섹션타입 키)
- [ ] 유사도 검색: 기존 생성 결과 중 80%+ 유사 시 재활용
- [ ] 인기 템플릿 야간 사전 생성 (cron job)
- **예상 절감: 반복 요청 시 70-90% 토큰 절약**

### 전략 4: 점진적 생성 (Incremental Generation)

재생성 시 전체가 아닌 변경 섹션만 재생성:

```
[현재] 재생성 = 25개 전 섹션 재작성 = ~80K 토큰
[개선] 재생성 = 변경 요청 섹션만 = ~3K 토큰 (96% 절감)
```

**구현 방법:**
- [ ] 섹션 단위 독립 생성 아키텍처
- [ ] 섹션별 버전 관리 + 개별 재생성 API
- [ ] "이 섹션만 다시 작성" 버튼
- [ ] 변경 섹션 → 연관 섹션 일관성 체크 (Reviewer 부분 실행)

### 전략 5: 토큰 버짓 시스템 (Token Budget Manager)

```
┌────────────────────────────────────────────┐
│          Token Budget Controller            │
├────────────────────────────────────────────┤
│                                              │
│  문서당 토큰 예산: 50,000 tokens             │
│  ┌──────────────────────────────┐           │
│  │ Architect:    5,000 (10%)    │           │
│  │ Writer 핵심: 25,000 (50%)    │           │
│  │ Writer 보조: 10,000 (20%)    │           │
│  │ Image:        3,000 (6%)     │           │
│  │ Reviewer:     5,000 (10%)    │           │
│  │ 여유분:       2,000 (4%)     │           │
│  └──────────────────────────────┘           │
│                                              │
│  초과 시: 자동으로 하위 모델 전환             │
│  미달 시: 여유분을 핵심 섹션에 재배분          │
│                                              │
└────────────────────────────────────────────┘
```

**구현 방법:**
- [ ] `TokenBudgetManager` 클래스
- [ ] 실시간 토큰 사용량 추적 (에이전트별)
- [ ] 예산 초과 경고 + 자동 모델 다운그레이드
- [ ] 사용자 대시보드에 토큰 사용 현황 표시
- [ ] Free 모드: 30K 예산 / Pro 모드: 80K 예산

### 전략 6: Output 최적화 (응답 길이 제어)

```
[현재] max_tokens 미설정 → 에이전트가 과다 생성하는 경우 발생
[개선] 섹션별 적정 토큰 수 사전 산정 + max_tokens 설정

섹션 타입별 Output 가이드:
┌────────────────────┬──────────┬──────────┐
│ 섹션 타입           │ 목표 글자  │ max_tokens│
├────────────────────┼──────────┼──────────┤
│ 핵심 (시장분석 등)   │ 1,000자  │ 2,000    │
│ 일반 (추진전략 등)   │ 600자    │ 1,200    │
│ 부록 (참고자료 등)   │ 300자    │ 600      │
│ 표/차트 설명        │ 200자    │ 400      │
└────────────────────┴──────────┴──────────┘
```

**구현 방법:**
- [ ] 섹션 타입별 `max_tokens` 매핑 테이블
- [ ] Architect가 섹션별 목표 길이 지정 (구조 설계 시)
- [ ] Writer에 `max_tokens` 동적 전달
- [ ] 과소 생성 시 보충 요청 (1회 한정)
- **예상 절감: Output 토큰 ~25% 감소**

### 📊 종합 절감 효과

```
┌──────────────────┬────────────┬────────────┬──────────┐
│ 전략              │ Input 절감  │ Output 절감 │ 비용 절감 │
├──────────────────┼────────────┼────────────┼──────────┤
│ 모델 라우팅       │ -          │ -          │ -40%     │
│ 프롬프트 압축     │ -60%       │ -          │ -15%     │
│ 캐싱 (히트 시)    │ -90%       │ -90%       │ -20%     │
│ 점진적 생성       │ -96%       │ -96%       │ -10%     │
│ 토큰 버짓        │ -          │ -15%       │ -5%      │
│ Output 최적화     │ -          │ -25%       │ -5%      │
├──────────────────┼────────────┼────────────┼──────────┤
│ 복합 적용 예상    │            │            │ -55~65%  │
└──────────────────┴────────────┴────────────┴──────────┘

현재: ~$0.52/문서 → 최적화 후: ~$0.18~0.23/문서
월 100건 기준: $52 → $18~23 (약 $30/월 절감)
```

### 🛠️ 구현 로드맵 (스프린트 통합)

| 전략 | 적용 스프린트 | 난이도 | 즉시 효과 |
|------|-------------|--------|----------|
| 모델 라우팅 | Sprint 1 | ⭐⭐ | ✅ 높음 |
| 프롬프트 압축 | Sprint 1 | ⭐⭐ | ✅ 높음 |
| Anthropic Prompt Cache | Sprint 1 | ⭐ | ✅ 높음 |
| Output 최적화 | Sprint 1 | ⭐ | ✅ 중간 |
| Redis 캐싱 | Sprint 2 | ⭐⭐⭐ | 중간 |
| 토큰 버짓 | Sprint 2 | ⭐⭐ | 중간 |
| 점진적 생성 | Sprint 3 | ⭐⭐⭐ | 중간 |
| 템플릿 사전생성 | Sprint 3 | ⭐⭐ | 낮음 |

> **Sprint 1에서만 모델 라우팅 + 프롬프트 압축 + Prompt Cache 적용 시 즉시 ~50% 절감 가능**

---

## 💰 비용 추정 (월별)

### 인프라
| 항목 | 현재 | v4.0 예상 |
|------|------|-----------|
| Railway (Backend) | $5/월 | $20/월 |
| Railway (PostgreSQL) | $5/월 | $10/월 |
| Railway (Redis) | - | $5/월 |
| Vercel (Frontend) | 무료 | $20/월 (Pro) |
| 도메인 | - | $15/년 |
| **소계** | **$10/월** | **$55/월** |

### API 비용 (사용량 기반)
| 항목 | 단가 | 월 예상 (100건 기준) |
|------|------|---------------------|
| Anthropic Claude (최적화 전) | ~$0.50/문서 | $50/월 |
| Anthropic Claude (최적화 후) | ~$0.20/문서 | $20/월 |
| Semantic Scholar | 무료 | $0 |
| arXiv | 무료 | $0 |
| Sentry | 무료 (5K events) | $0 |
| Stripe 수수료 | 3.4%+₩400 | 매출 비례 |
| **소계** | | **~$50/월** |

### 총 월 운영비 예상
- **최적화 전**: ~$105/월 (현재 $10 → 10.5배)
- **토큰 최적화 후**: ~$75/월 (API 비용 $50→$20)

### 손익분기점
- Pro 구독 ₩29,900/월 기준
- **최적화 후**: 3명 구독 시 ₩89,700 ≈ $67 → 거의 손익분기
- 5명 구독 시 안정적 수익 발생
- 10명 구독 시 월 $150+ 순이익

---

## 📋 우선순위 매트릭스

```
영향력 높음
    │
    │  [Sprint 1]        [Sprint 3]
    │  백엔드 강화        심층 연구
    │
    │  [Sprint 2]        [Sprint 4]
    │  Free/Pro          목업 빌더
    │
    │  [Sprint 6]        [Sprint 5]
    │  최적화/런칭        협업 기능
    │
    └──────────────────────────────▶
      구현 난이도 낮음         높음
```

Sprint 1 → 2 → 3 순서는 **필수** (의존성).
Sprint 4, 5는 Sprint 3 이후 **병렬 가능**.
Sprint 6은 모든 스프린트 이후 **최종 마무리**.

---

## 🔑 핵심 의존성

```
Sprint 1 (인프라) ─┬──▶ Sprint 2 (결제) ──▶ Sprint 3 (연구 엔진)
                   │                              │
                   └──▶ Sprint 5 (협업) ◀──────────┤
                                                   │
                        Sprint 4 (목업) ◀──────────┘
                              │
                              ▼
                        Sprint 6 (런칭)
```

---

*본 계획은 1인 개발 + AI 에이전트 보조 기준입니다. 팀 확장 시 스프린트 기간이 단축될 수 있습니다.*
